import { useState, useEffect, useRef, useCallback } from 'react';
import { Document, Page, pdfjs } from 'react-pdf';
import { X, Download, ZoomIn, ZoomOut, ChevronLeft, ChevronRight, RotateCw, Maximize2, Minimize2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { useIsMobile } from '@/hooks/use-mobile';
import { cn } from '@/lib/utils';

// Configure PDF.js worker - CONFIGURAﾃﾃグ SIMPLES
if (typeof window !== 'undefined' && 'Worker' in window) {
  pdfjs.GlobalWorkerOptions.workerSrc = `https://unpkg.com/pdfjs-dist@${pdfjs.version}/build/pdf.worker.min.js`;
}

// Detectar Safari Mobile
const isSafariMobile = () => {
  const ua = navigator.userAgent;
  return /iPhone|iPad|iPod/.test(ua) && /Safari/.test(ua) && !/CriOS|FxiOS|OPiOS/.test(ua);
};

interface InternalPdfViewerProps {
  pdfUrl: string;
  title: string;
  isOpen: boolean;
  onClose: () => void;
  allowDownload?: boolean;
  onDownload?: (url: string, filename: string) => void;
  customStyles?: {
    closeButtonColor?: string;
    controlsColor?: string;
    headerBgColor?: string;
    controlsBarColor?: string;
  };
}

interface PageCache {
  [key: number]: HTMLCanvasElement;
}

export const InternalPdfViewer = ({ 
  pdfUrl, 
  title, 
  isOpen, 
  onClose, 
  allowDownload = true,
  onDownload,
  customStyles
}: InternalPdfViewerProps) => {
  // Custom style colors with defaults
  const closeButtonColor = customStyles?.closeButtonColor || undefined;
  const controlsColor = customStyles?.controlsColor || undefined;
  const headerBgColor = customStyles?.headerBgColor || undefined;
  
  // Detectar Safari Mobile
  const isSafari = isSafariMobile();
  
  // TODOS OS HOOKS DEVEM VIR ANTES DE QUALQUER RETURN CONDICIONAL
  const isMobile = useIsMobile();
  const containerRef = useRef<HTMLDivElement>(null);
  const touchRef = useRef<HTMLDivElement>(null);
  
  // PDF states - SIMPLES
  const [numPages, setNumPages] = useState<number>(0);
  const [currentPage, setCurrentPage] = useState<number>(1);
  const [scale, setScale] = useState(1.0);
  const [rotation, setRotation] = useState(0);
  const [isFullscreen, setIsFullscreen] = useState(false);
  
  // Touch states
  const [isPinching, setIsPinching] = useState(false);
  const [lastPinchDistance, setLastPinchDistance] = useState(0);
  const [isDragging, setIsDragging] = useState(false);
  const [lastTouch, setLastTouch] = useState({ x: 0, y: 0 });
  const [viewOffset, setViewOffset] = useState({ x: 0, y: 0 });
  
  // Touch states
  const [isPinching, setIsPinching] = useState(false);
  const [lastPinchDistance, setLastPinchDistance] = useState(0);
  const [isDragging, setIsDragging] = useState(false);
  const [lastTouch, setLastTouch] = useState({ x: 0, y: 0 });
  const [viewOffset, setViewOffset] = useState({ x: 0, y: 0 });
  
  // Se for Safari Mobile, abrir PDF externamente ao invﾃｩs de modal
  useEffect(() => {
    if (isSafari && isOpen) {
      // Detectar se estﾃ｡ em modo standalone (PWA instalado)
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                          (window.navigator as any).standalone ||
                          document.referrer.includes('android-app://');
      
      if (isStandalone) {
        // Em PWA, criar link temporﾃ｡rio e forﾃｧar abertura no Safari
        const link = document.createElement('a');
        link.href = pdfUrl;
        link.target = '_system'; // Forﾃｧa abertura no navegador do sistema
        link.rel = 'noopener noreferrer';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } else {
        // Nﾃ｣o estﾃ｡ em PWA, abrir normalmente
        window.open(pdfUrl, '_blank', 'noopener,noreferrer');
      }
      
      // Fechar o modal apﾃｳs 300ms
      setTimeout(() => {
        onClose();
      }, 300);
    }
  }, [isSafari, isOpen, pdfUrl, onClose]);

  // Reset states when opening/closing
  useEffect(() => {
    if (isOpen) {
      setCurrentPage(1);
      setScale(isMobile ? 1.0 : 1.2);
      setRotation(0);
      setViewOffset({ x: 0, y: 0 });
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }

    return () => {
      document.body.style.overflow = 'unset';
    };
  }, [isOpen, isMobile]);

  // PDF loading - validaﾃｧﾃ｣o apenas
  const loadPdf = useCallback(async (url: string, attempt: number = 1) => {
    setIsLoading(true);
    setError(null);
    
    try {
      const loadingTask = pdfjs.getDocument({
        url,
        cMapUrl: `https://unpkg.com/pdfjs-dist@${pdfjs.version}/cmaps/`,
        cMapPacked: true,
      });

      const pdf = await loadingTask.promise;
      setNumPages(pdf.numPages);
      setIsLoading(false);
      
      // Limpar o documento apﾃｳs obter informaﾃｧﾃｵes
      pdf.destroy();
      
    } catch (err: any) {
      console.error(`PDF loading attempt ${attempt} failed:`, err);
      
      if (attempt < 2) {
        // Retry com configuraﾃｧﾃ｣o mais conservadora
        setTimeout(() => {
          loadPdf(url, attempt + 1);
        }, 500 * attempt);
      } else {
        // Final fallback: try as blob
        try {
          const response = await fetch(url);
          const blob = await response.blob();
          const blobUrl = URL.createObjectURL(blob);
          
          const fallbackTask = pdfjs.getDocument({
            url: blobUrl,
            cMapUrl: `https://unpkg.com/pdfjs-dist@${pdfjs.version}/cmaps/`,
            cMapPacked: true,
          });
          
          const pdf = await fallbackTask.promise;
          setPdfDocument(pdf);
          setNumPages(pdf.numPages);
          setIsLoading(false);
        } catch (blobErr) {
          setError('Falha ao carregar o PDF. Verifique sua conexﾃ｣o e tente novamente.');
          setIsLoading(false);
        }
      }
      setRetryCount(attempt);
    }
  }, []);

  // 笨 OTIMIZAﾃﾃグ: Pre-load inteligente apenas de pﾃ｡ginas adjacentes
  const preloadPages = useCallback(async (pdf: any, start: number, end: number) => {
    // Limitar pre-load a no mﾃ｡ximo 2 pﾃ｡ginas por vez
    const maxPreload = Math.min(end, start + 1);
    
    for (let pageNum = start; pageNum <= maxPreload; pageNum++) {
      if (!pageCache[pageNum] && pageNum <= pdf.numPages) {
        setLoadingPages(prev => new Set(prev).add(pageNum));
        try {
          const page = await pdf.getPage(pageNum);
          
          // 笨 OTIMIZAﾃﾃグ: Usar escala baixa para pre-cache (1.0 ao invﾃｩs de escala atual)
          const viewport = page.getViewport({ scale: 1.0 });
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d', { 
            alpha: false, // 笨 OTIMIZAﾃﾃグ: Sem transparﾃｪncia = mais rﾃ｡pido
            willReadFrequently: false 
          });
          
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          
          await page.render({
            canvasContext: context,
            viewport: viewport,
          }).promise;
          
          pageCache[pageNum] = canvas;
        } catch (err) {
          console.error(`Failed to preload page ${pageNum}:`, err);
        } finally {
          setLoadingPages(prev => {
            const newSet = new Set(prev);
            newSet.delete(pageNum);
            return newSet;
          });
        }
      }
    }
  }, [pageCache]);

  // Load PDF when component opens
  useEffect(() => {
    if (isOpen && pdfUrl && !isSafari) {
      loadPdf(pdfUrl);
    }
  }, [isOpen, pdfUrl, loadPdf, isSafari]);
  
  // Se for Safari e o modal estﾃ｡ aberto, nﾃ｣o renderizar o viewer
  if (isSafari && isOpen) {
    return null;
  }
  
  // Se nﾃ｣o estﾃ｡ aberto, nﾃ｣o renderizar
  if (!isOpen) {
    return null;
  }

  // Se for Safari e o modal estﾃ｡ aberto, nﾃ｣o renderizar o viewer
  if (isSafari && isOpen) {
    return null;
  }
  
  // Se nﾃ｣o estﾃ｡ aberto, nﾃ｣o renderizar
  if (!isOpen) {
    return null;
  }

  // Touch gesture handlers
  const getTouchDistance = (touches: React.TouchList) => {
    if (touches.length < 2) return 0;
    const touch1 = touches[0];
    const touch2 = touches[1];
    return Math.sqrt(
      Math.pow(touch2.clientX - touch1.clientX, 2) + 
      Math.pow(touch2.clientY - touch1.clientY, 2)
    );
  };

  const handleTouchStart = (e: React.TouchEvent) => {
    if (e.touches.length === 2) {
      setIsPinching(true);
      setLastPinchDistance(getTouchDistance(e.touches));
    } else if (e.touches.length === 1) {
      setIsDragging(true);
      setLastTouch({
        x: e.touches[0].clientX,
        y: e.touches[0].clientY
      });
    }
  };

  const handleTouchMove = (e: React.TouchEvent) => {
    e.preventDefault();
    
    if (e.touches.length === 2 && isPinching) {
      const distance = getTouchDistance(e.touches);
      const scaleFactor = distance / lastPinchDistance;
      const newScale = Math.max(0.5, Math.min(3.0, scale * scaleFactor));
      setScale(newScale);
      setLastPinchDistance(distance);
    } else if (e.touches.length === 1 && isDragging && scale > 1) {
      const deltaX = e.touches[0].clientX - lastTouch.x;
      const deltaY = e.touches[0].clientY - lastTouch.y;
      
      setViewOffset(prev => ({
        x: prev.x + deltaX,
        y: prev.y + deltaY
      }));
      
      setLastTouch({
        x: e.touches[0].clientX,
        y: e.touches[0].clientY
      });
    }
  };

  const handleTouchEnd = () => {
    setIsPinching(false);
    setIsDragging(false);
    setLastPinchDistance(0);
  };

  // Navigation functions - 笨 OTIMIZAﾃﾃグ: Pre-load apenas prﾃｳxima pﾃ｡gina
  const goToPage = (pageNumber: number) => {
    const newPage = Math.max(1, Math.min(numPages, pageNumber));
    setCurrentPage(newPage);
    
    // 笨 OTIMIZAﾃﾃグ: Pre-load apenas a prﾃｳxima pﾃ｡gina (nﾃ｣o anterior e prﾃｳxima)
    if (pdfDocument && newPage < numPages) {
      preloadPages(pdfDocument, newPage + 1, newPage + 1);
    }
  };

  const nextPage = () => goToPage(currentPage + 1);
  const prevPage = () => goToPage(currentPage - 1);

  // Zoom functions
  const zoomIn = () => setScale(prev => Math.min(3.0, prev + 0.25));
  const zoomOut = () => setScale(prev => Math.max(0.5, prev - 0.25));
  const resetZoom = () => {
    setScale(isMobile ? 1.0 : 1.2);
    setViewOffset({ x: 0, y: 0 });
  };

  // Rotation
  const rotate = () => setRotation(prev => (prev + 90) % 360);

  // Fullscreen
  const toggleFullscreen = () => {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen?.();
      setIsFullscreen(true);
    } else {
      document.exitFullscreen?.();
      setIsFullscreen(false);
    }
  };

  // Download
  const handleDownload = () => {
    if (onDownload) {
      const filename = `${title.replace(/\s+/g, '_').toLowerCase()}.pdf`;
      onDownload(pdfUrl, filename);
    }
  };

  // Retry loading
  const retryLoad = () => {
    setRetryCount(0);
    loadPdf(pdfUrl);
  };

  // Keyboard navigation
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (!isOpen) return;
      
      switch (e.key) {
        case 'Escape':
          onClose();
          break;
        case 'ArrowLeft':
          prevPage();
          break;
        case 'ArrowRight':
          nextPage();
          break;
        case '+':
        case '=':
          zoomIn();
          break;
        case '-':
          zoomOut();
          break;
        case '0':
          resetZoom();
          break;
        case 'r':
          rotate();
          break;
        case 'f':
          toggleFullscreen();
          break;
      }
    };

    if (isOpen) {
      document.addEventListener('keydown', handleKeyDown);
      return () => document.removeEventListener('keydown', handleKeyDown);
    }
  }, [isOpen, currentPage, numPages]);

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 bg-background/95 backdrop-blur-sm">
      {/* Header Controls */}
      <div 
        className="absolute top-0 left-0 right-0 z-10 backdrop-blur-sm border-b border-border"
        style={{ backgroundColor: headerBgColor ? `${headerBgColor}e6` : undefined }}
      >
        <div className={cn("flex items-center justify-between", isMobile ? "p-2" : "p-4")}>
          <div className="flex-1 min-w-0">
            <h2 
              className="font-semibold text-lg truncate"
              style={{ color: controlsColor }}
            >
              {title}
            </h2>
            <p 
              className="text-sm"
              style={{ color: controlsColor ? `${controlsColor}99` : undefined }}
            >
              {numPages > 0 && `Pﾃ｡gina ${currentPage} de ${numPages}`}
            </p>
          </div>
          
          <div className={cn("flex items-center gap-1", isMobile ? "ml-2" : "ml-4 gap-2")}>
            {/* Navigation */}
            {numPages > 1 && (
              <>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={prevPage}
                  disabled={currentPage <= 1}
                  className="p-2"
                  style={{ color: controlsColor }}
                >
                  <ChevronLeft className="w-4 h-4" />
                </Button>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={nextPage}
                  disabled={currentPage >= numPages}
                  className="p-2"
                  style={{ color: controlsColor }}
                >
                  <ChevronRight className="w-4 h-4" />
                </Button>
              </>
            )}
            
            {/* Zoom Controls */}
            <Button 
              variant="ghost" 
              size="sm" 
              onClick={zoomOut} 
              className="p-2"
              style={{ color: controlsColor }}
            >
              <ZoomOut className="w-4 h-4" />
            </Button>
            <Button 
              variant="ghost" 
              size="sm" 
              onClick={zoomIn} 
              className="p-2"
              style={{ color: controlsColor }}
            >
              <ZoomIn className="w-4 h-4" />
            </Button>
            
            {/* Rotate */}
            <Button 
              variant="ghost" 
              size="sm" 
              onClick={rotate} 
              className="p-2"
              style={{ color: controlsColor }}
            >
              <RotateCw className="w-4 h-4" />
            </Button>
            
            {/* Fullscreen */}
            <Button 
              variant="ghost" 
              size="sm" 
              onClick={toggleFullscreen} 
              className="p-2"
              style={{ color: controlsColor }}
            >
              {isFullscreen ? <Minimize2 className="w-4 h-4" /> : <Maximize2 className="w-4 h-4" />}
            </Button>
            
            {/* Download */}
            {allowDownload && onDownload && (
              <Button 
                variant="ghost" 
                size="sm" 
                onClick={handleDownload} 
                className="p-2"
                style={{ color: controlsColor }}
              >
                <Download className="w-4 h-4" />
              </Button>
            )}
            
            {/* Close */}
            <Button 
              variant="ghost" 
              size="sm" 
              onClick={onClose} 
              className="p-2"
              style={{ color: closeButtonColor }}
            >
              <X className="w-4 h-4" />
            </Button>
          </div>
        </div>
      </div>

      {/* PDF Content */}
      <div 
        ref={containerRef}
        className={cn("absolute inset-0 overflow-auto", isMobile ? "pt-16" : "pt-20")}
        style={{ backgroundColor: '#f5f5f5' }}
      >
        {error ? (
          <div className="flex flex-col items-center justify-center h-full p-4">
            <div className="bg-destructive/10 border border-destructive/20 rounded-lg p-6 max-w-md text-center">
              <p className="text-destructive mb-4">{error}</p>
              <Button onClick={retryLoad} variant="outline">
                Tentar Novamente
              </Button>
              {retryCount > 0 && (
                <p className="text-muted-foreground text-sm mt-2">
                  Tentativa {retryCount}/3
                </p>
              )}
            </div>
          </div>
        ) : (
          <div
            ref={touchRef}
            className="flex items-center justify-center min-h-full p-4"
            onTouchStart={handleTouchStart}
            onTouchMove={handleTouchMove}
            onTouchEnd={handleTouchEnd}
          >
            {!isLoading && numPages > 0 && (
              <div 
                style={{
                  transform: `scale(${scale}) rotate(${rotation}deg) translate(${viewOffset.x}px, ${viewOffset.y}px)`,
                  transformOrigin: 'center',
                  transition: isPinching || isDragging ? 'none' : 'transform 0.2s ease'
                }}
              >
                <Document
                  file={pdfUrl}
                  onLoadSuccess={({ numPages }) => setNumPages(numPages)}
                  options={{
                    cMapUrl: `https://unpkg.com/pdfjs-dist@${pdfjs.version}/cmaps/`,
                    cMapPacked: true,
                  }}
                >
                  <Page
                    pageNumber={currentPage}
                    renderTextLayer={true}
                    renderAnnotationLayer={true}
                    width={isMobile ? Math.min(window.innerWidth - 32, 800) : 900}
                    className="shadow-lg"
                  />
                </Document>
              </div>
            )}
          </div>
        )}
      </div>

      {/* Mobile Instructions */}
      {isMobile && !error && (
        <div className="absolute bottom-4 left-4 right-4 z-10">
          <div className="bg-background/90 backdrop-blur-sm border border-border rounded-lg p-3 text-center">
            <p className="text-muted-foreground text-sm">
              庁 Use gestos de pinﾃｧa para zoom 窶｢ Deslize para navegar
            </p>
          </div>
        </div>
      )}

      {/* Page Navigation for Mobile */}
      {isMobile && numPages > 1 && !error && (
        <div className="absolute bottom-16 left-1/2 transform -translate-x-1/2 z-10">
          <div className="bg-background/90 backdrop-blur-sm border border-border rounded-full px-4 py-2">
            <span className="text-sm font-medium">
              {currentPage} / {numPages}
            </span>
          </div>
        </div>
      )}

      {/* Loading Overlay */}
      {isLoading && (
        <div className="absolute inset-0 bg-background/50 flex items-center justify-center">
          <div className="bg-background border border-border rounded-lg p-6 flex items-center gap-3 shadow-lg">
            <div className="w-6 h-6 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
            <span>Carregando PDF...</span>
          </div>
        </div>
      )}
    </div>
  );
};